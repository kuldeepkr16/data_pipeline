version: '3.8'

services:
  # Source PostgreSQL Database
  source_pg_db:
    build:
      context: ./databases/source_pg_db
    container_name: source_pg_db
    ports:
      - "5434:5432" # Mapped to 5434 to avoid conflict with local Postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: source_db
    volumes:
      # Mount tables script with 01_ prefix so it runs BEFORE user creation (99_init.sql)
      - ./databases/source_pg_db/initial_tables.sql:/docker-entrypoint-initdb.d/01_initial_tables.sql
    networks:
      - data_pipeline_net

  # Sink PostgreSQL Database
  sink_pg_db:
    build:
      context: ./databases/sink_pg_db
    container_name: sink_pg_db
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: sink_db
    volumes:
      - ./databases/sink_pg_db/data:/var/lib/postgresql/data
    networks:
      - data_pipeline_net

  # MinIO Object Storage
  minio:
    build:
      context: ./datalake/minio_resources/minio
    container_name: minio_server
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - ./datalake/minio_resources/data:/data
    command: server /data --console-address ":9001"
    networks:
      - data_pipeline_net

  # SQLite Configuration Database
  config_db:
    build:
      context: ./databases/config_db
    container_name: config_db
    volumes:
      - ./databases/config_db/data:/data
    networks:
      - data_pipeline_net

  # Backend API (FastAPI)
  backend:
    build:
      context: ./backend
    container_name: backend_api
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app # Mount source code for dev
      - ./databases/config_db/data:/data # Mount the same volume to access config.db
      - /var/run/docker.sock:/var/run/docker.sock # Mount Docker socket for triggering pipelines
    environment:
      - ENCRYPTION_KEY=3h13R1YpQCqKfbRaUEAYr6xs9XtGr2aHM2X_7DmlpOk=
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=datalake
    networks:
      - data_pipeline_net
    depends_on:
      - config_db

  # Frontend (Next.js)
  frontend:
    build:
      context: ./frontend
    container_name: frontend_ui
    ports:
      - "3000:3000"
    networks:
      - data_pipeline_net
    # In development, we use volumes to sync code changes
    volumes:
      - ./frontend:/app
      - /app/node_modules

  # Pipeline Worker (Executes Data Transfers)
  pipeline_worker:
    build:
      context: ./data_pipeline_resources/pipeline_worker
    container_name: pipeline_worker
    environment:
      CONFIG_DB_PATH: /data/config.db
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: datalake
      ENCRYPTION_KEY: 3h13R1YpQCqKfbRaUEAYr6xs9XtGr2aHM2X_7DmlpOk=
    volumes:
      - ./databases/config_db/data:/data
      - ./data_pipeline_resources/pipeline_worker/loaders:/loaders
    networks:
      - data_pipeline_net
    depends_on:
      - config_db
      - source_pg_db
      - sink_pg_db
      - minio
    command: tail -f /dev/null

networks:
  data_pipeline_net:
    driver: bridge
