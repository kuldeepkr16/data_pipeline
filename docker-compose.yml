version: '3.8'

services:
  # Source PostgreSQL Database
  source_pg_db:
    build:
      context: ./databases/source_pg_db
    container_name: source_pg_db
    ports:
      - "5434:5432" # Mapped to 5434 to avoid conflict with local Postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: source_db
    volumes:
      # Mount tables script with 01_ prefix so it runs BEFORE user creation (99_init.sql)
      - ./databases/source_pg_db/initial_tables.sql:/docker-entrypoint-initdb.d/01_initial_tables.sql
    networks:
      - data_pipeline_net

  # Sink PostgreSQL Database
  sink_pg_db:
    build:
      context: ./databases/sink_pg_db
    container_name: sink_pg_db
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: sink_db
    networks:
      - data_pipeline_net

  # MinIO Object Storage
  minio:
    build:
      context: ./datalake/minio_resources
    container_name: minio_server
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - ./datalake/minio_resources/data:/data
    command: server /data --console-address ":9001"
    networks:
      - data_pipeline_net

  # SQLite Configuration Database
  config_db:
    build:
      context: ./databases/config_db
    container_name: config_db
    volumes:
      - ./databases/config_db/data:/data
    networks:
      - data_pipeline_net

  # Backend API (FastAPI)
  backend:
    build:
      context: ./backend
    container_name: backend_api
    ports:
      - "8000:8000"
    volumes:
      - ./databases/config_db/data:/data # Mount the same volume to access config.db
    networks:
      - data_pipeline_net
    depends_on:
      - config_db

  # Frontend (Next.js)
  frontend:
    build:
      context: ./frontend
    container_name: frontend_ui
    ports:
      - "3000:3000"
    networks:
      - data_pipeline_net
    # In development, we use volumes to sync code changes
    volumes:
      - ./frontend:/app
      - /app/node_modules

  # Driver Script for Source to Data Lake
  driver_source_to_dl:
    build:
      context: ./data_pipeline_resources/source_to_dl/driver_source_to_dl
    container_name: driver_source_to_dl
    environment:
      CONFIG_DB_PATH: /data/config.db
      POSTGRES_HOST: source_pg_db
      POSTGRES_PORT: 5432
      POSTGRES_DB: source_db
      POSTGRES_USER: read_user
      POSTGRES_PASSWORD: read_password
      MINIO_ENDPOINT: minio_server:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: datalake
    volumes:
      - ./databases/config_db/data:/data
      - ./data_pipeline_resources/source_to_dl:/loaders
    networks:
      - data_pipeline_net
    depends_on:
      - config_db
      - source_pg_db
      - minio
    # This service doesn't run continuously, it's executed on demand
    command: tail -f /dev/null

  # Driver Script for Data Lake to Sink
  driver_dl_to_sink:
    build:
      context: ./data_pipeline_resources/dl_to_sink/driver_dl_to_sink
    container_name: driver_dl_to_sink
    environment:
      CONFIG_DB_PATH: /data/config.db
      SINK_POSTGRES_HOST: sink_pg_db
      SINK_POSTGRES_PORT: 5432
      SINK_POSTGRES_DB: sink_db
      SINK_POSTGRES_USER: postgres
      SINK_POSTGRES_PASSWORD: postgres
      MINIO_ENDPOINT: minio_server:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: datalake
    volumes:
      - ./databases/config_db/data:/data
      - ./data_pipeline_resources/dl_to_sink:/loaders
    networks:
      - data_pipeline_net
    depends_on:
      - config_db
      - sink_pg_db
      - minio
    # This service doesn't run continuously, it's executed on demand
    command: tail -f /dev/null

networks:
  data_pipeline_net:
    driver: bridge
